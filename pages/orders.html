<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order History - FoodStudent</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Base Styles */
    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #eee;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .orders-title {
      font-size: 2rem;
      color: #ff5722;
      margin-bottom: 2rem;
      text-align: center;
    }

    /* Order History Section */
    .orders-section {
      background: #1f1f1f;
      border-radius: 16px;
      padding: 1.5rem;
    }

    .section-title {
      font-size: 1.2rem;
      color: #fff;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .orders-list {
      display: grid;
      gap: 1.5rem;
    }

    .order-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      border-left: 4px solid #ff5722;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #333;
    }

    .order-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .edit-btn {
      background: #2196f3;
      color: white;
    }

    .edit-btn:hover {
      background: #1976d2;
      transform: translateY(-1px);
    }

    .delete-btn {
      background: #f44336;
      color: white;
    }

    .delete-btn:hover {
      background: #d32f2f;
      transform: translateY(-1px);
    }

    .cancel-btn {
      background: #ff9800;
      color: white;
    }

    .cancel-btn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }

    .order-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .order-id {
      font-weight: 600;
      color: #ff5722;
      font-size: 1.1rem;
    }

    .order-date {
      color: #aaa;
      font-size: 0.9rem;
    }

    .order-status {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #ff9800;
      color: #000;
    }

    .status-confirmed {
      background: #2196f3;
      color: #fff;
    }

    .status-preparing {
      background: #9c27b0;
      color: #fff;
    }

    .status-delivered {
      background: #4caf50;
      color: #fff;
    }

    .status-cancelled {
      background: #f44336;
      color: #fff;
    }

    .restaurant-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      color: #fff;
    }

    .restaurant-icon {
      color: #ff5722;
    }

    .order-items {
      display: grid;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .order-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 1rem;
      padding: 1rem;
      background: #1f1f1f;
      border-radius: 8px;
      align-items: center;
    }

    .item-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
    }

    .item-details {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .item-name {
      font-weight: 600;
      color: #fff;
      margin: 0;
    }

    .item-price {
      color: #ff5722;
      margin: 0;
      font-size: 0.9rem;
    }

    .item-quantity {
      color: #aaa;
      font-size: 0.9rem;
    }

    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid #333;
      font-weight: 600;
      color: #fff;
    }

    .total-amount {
      color: #ff5722;
      font-size: 1.2rem;
    }

    .empty-orders {
      text-align: center;
      padding: 3rem;
      background: #2a2a2a;
      border-radius: 12px;
      color: #888;
    }

    .empty-orders i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: #666;
    }

    .empty-orders h3 {
      color: #fff;
      margin: 0 0 1rem;
    }

    .empty-orders p {
      margin: 0 0 1.5rem;
    }

    .empty-orders .action-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: #ff5722;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .empty-orders .action-button:hover {
      background: #ff8a50;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #aaa;
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 1rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      text-align: center;
      padding: 2rem;
      background: #2a2a2a;
      border-radius: 12px;
      color: #f44336;
      border: 1px solid #f44336;
    }

    @media (max-width: 768px) {
      .order-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .order-item {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .item-image {
        margin: 0 auto;
      }

      .order-total {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }
    }

    /* --- Enhanced Checkout UI --- */
    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
    }
    @media (max-width: 900px) {
      .checkout-grid {
        grid-template-columns: 1fr;
      }
      .summary-section {
        position: static !important;
        margin-top: 2rem;
      }
    }
    .cart-section, .summary-section {
      background: #1f1f1f;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.18);
      transition: box-shadow 0.2s;
    }
    .cart-section:hover, .summary-section:hover {
      box-shadow: 0 8px 32px 0 rgba(255,87,34,0.12);
    }
    .cart-items .order-item {
      transition: box-shadow 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
      background: #232323;
      border: 1px solid #292929;
    }
    .cart-items .order-item:hover {
      box-shadow: 0 4px 16px 0 rgba(255,87,34,0.10);
      transform: translateY(-2px) scale(1.01);
    }
    .checkout-btn {
      box-shadow: 0 2px 8px 0 rgba(255,87,34,0.18);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    }
    .checkout-btn:hover:not(:disabled) {
      background: #ff784e;
      box-shadow: 0 4px 16px 0 rgba(255,87,34,0.22);
      transform: translateY(-2px) scale(1.01);
    }
    .payment-method.selected {
      border: 2px solid #ff5722 !important;
      background: #2a2a2a !important;
      box-shadow: 0 2px 12px 0 rgba(255,87,34,0.10);
    }
    .payment-method {
      transition: border 0.2s, background 0.2s, box-shadow 0.2s;
    }
    .payment-method:focus {
      outline: 2px solid #ff5722;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    .summary-row.total {
      font-size: 1.2rem;
      font-weight: 700;
      color: #ff5722;
      margin-top: 1rem;
    }
    .discount-row .amount {
      color: #4caf50;
    }
    .voucher-input {
      border-radius: 6px;
      border: 1px solid #333;
      padding: 0.5rem 1rem;
      background: #232323;
      color: #fff;
      font-size: 1rem;
      width: 60%;
      transition: border 0.2s;
    }
    .voucher-input:focus {
      border: 1.5px solid #ff5722;
      outline: none;
    }
    .apply-voucher-btn {
      background: #ff5722;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .apply-voucher-btn:hover {
      background: #ff784e;
    }
    .form-group label {
      color: #bbb;
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
      display: block;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      border: 1px solid #333;
      background: #232323;
      color: #fff;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      transition: border 0.2s;
    }
    .form-group input:focus, .form-group select:focus {
      border: 1.5px solid #ff5722;
      outline: none;
    }
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 4px solid #ff5722;
      border-top: 4px solid #232323;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Edit Modal Styles */
    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .edit-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .edit-modal-content {
      background: #1f1f1f;
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .edit-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #333;
    }

    .edit-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ff5722;
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .close-modal:hover {
      background: #333;
      color: #fff;
    }

    .edit-form-group {
      margin-bottom: 1.5rem;
    }

    .edit-form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #fff;
      font-weight: 600;
    }

    .edit-form-group input,
    .edit-form-group select {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #333;
      border-radius: 8px;
      background: #2a2a2a;
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .edit-form-group input:focus,
    .edit-form-group select:focus {
      outline: none;
      border-color: #ff5722;
    }

    .edit-modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    .save-btn {
      background: #4caf50;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .save-btn:hover {
      background: #45a049;
      transform: translateY(-1px);
    }

    .save-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    /* Confirmation Modal */
    .confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .confirm-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .confirm-modal-content {
      background: #1f1f1f;
      border-radius: 16px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .confirm-modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #f44336;
      margin-bottom: 1rem;
    }

    .confirm-modal-message {
      color: #ccc;
      margin-bottom: 2rem;
      line-height: 1.5;
    }

    .confirm-modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .confirm-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .confirm-btn:hover {
      background: #d32f2f;
      transform: translateY(-1px);
    }

    .cancel-confirm-btn {
      background: #666;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .cancel-confirm-btn:hover {
      background: #555;
      transform: translateY(-1px);
    }

    /* Payment Method Cards */
    .payment-methods {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    @media (max-width: 900px) {
      .payment-methods {
        flex-direction: column;
        gap: 1rem;
      }
    }
    .payment-method {
      flex: 1 1 0;
      min-width: 180px;
      background: #232323;
      border: 2px solid #333;
      border-radius: 14px;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
      padding: 1.2rem 1rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      cursor: pointer;
      transition: border 0.2s, background 0.2s, box-shadow 0.2s, transform 0.1s;
      outline: none;
      position: relative;
    }
    .payment-method.selected {
      border: 2.5px solid #ff5722 !important;
      background: #282828 !important;
      box-shadow: 0 4px 16px 0 rgba(255,87,34,0.10);
      transform: scale(1.03);
    }
    .payment-method:focus {
      outline: 2px solid #ff5722;
      z-index: 2;
    }
    .payment-method:hover:not(.selected) {
      border: 2px solid #ff784e;
      background: #262626;
      box-shadow: 0 4px 16px 0 rgba(255,87,34,0.08);
      transform: scale(1.01);
    }
    .payment-icon {
      font-size: 2.2rem;
      color: #ff5722;
      margin-bottom: 0.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .payment-info h3 {
      margin: 0;
      font-size: 1.08rem;
      font-weight: 600;
      color: #fff;
      text-align: center;
    }
    .payment-info p {
      margin: 0;
      font-size: 0.95rem;
      color: #bbb;
      text-align: center;
    }

    /* Confirmation Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #232323;
      border-radius: 16px;
      padding: 2rem 2.5rem;
      box-shadow: 0 8px 32px 0 rgba(255,87,34,0.18);
      text-align: center;
      color: #fff;
      max-width: 90vw;
    }
    .modal h2 {
      color: #ff5722;
      margin-bottom: 1rem;
    }
    .modal .modal-btn {
      margin-top: 1.5rem;
      background: #ff5722;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 2rem;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal .modal-btn:hover {
      background: #ff784e;
    }

    .item-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .quantity-control {
      background: #333;
      border: none;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.2s;
    }
    .quantity-control:hover {
      background: #ff5722;
    }
    .item-quantity-display {
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }
    .delete-cart-item-btn {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 1rem;
      transition: color 0.2s;
    }
    .delete-cart-item-btn:hover {
      color: #f44336;
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <div class="container">
    <h1 class="orders-title">Checkout</h1>
    <div id="checkout-section" style="margin-bottom: 2rem;"></div>
    
    <!-- Add Orders List Section -->
    <div class="orders-section">
      <h2 class="section-title"><i class="fas fa-receipt"></i> Your Orders</h2>
      <div id="orders-list" class="orders-list">
        <!-- Orders will be displayed here -->
      </div>
    </div>
  </div>

  <div id="footer-container"></div>

  <!-- Edit Order Modal -->
  <div id="edit-modal" class="edit-modal">
    <div class="edit-modal-content">
      <div class="edit-modal-header">
        <h3 class="edit-modal-title">Edit Order</h3>
        <button class="close-modal" onclick="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="edit-order-form">
        <div class="edit-form-group">
          <label for="edit-status">Order Status</label>
          <select id="edit-status" name="status">
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="preparing">Preparing</option>
            <option value="ready">Ready</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="edit-form-group">
          <label for="edit-quantity">Quantity</label>
          <input type="number" id="edit-quantity" name="quantity" min="1" required>
        </div>
        <div class="edit-modal-actions">
          <button type="button" class="cancel-confirm-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="save-btn" id="save-order-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="confirm-modal" class="confirm-modal">
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title">Delete Order</h3>
      <p class="confirm-modal-message">Are you sure you want to delete this order? This action cannot be undone.</p>
      <div class="confirm-modal-actions">
        <button class="cancel-confirm-btn" onclick="closeConfirmModal()">Cancel</button>
        <button class="confirm-btn" id="confirm-delete-btn">Delete Order</button>
      </div>
    </div>
  </div>

  <script>
    // Load navbar
    fetch('../components/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-container').innerHTML = html;
      });

    // Load footer
    fetch('../components/footer.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('footer-container').innerHTML = html;
      });

    // Get current user
    function getCurrentUser() {
      const user = localStorage.getItem('user');
      return user ? JSON.parse(user) : null;
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Get status class
    function getStatusClass(status) {
      const statusMap = {
        'PENDING': 'status-pending',
        'CONFIRMED': 'status-confirmed',
        'PREPARING': 'status-preparing',
        'DELIVERED': 'status-delivered',
        'CANCELLED': 'status-cancelled'
      };
      return statusMap[status] || 'status-pending';
    }

    // Fetch user orders
    async function fetchUserOrders(userId) {
      try {
        console.log('Fetching orders for user:', userId);
        const response = await fetch(`/api/orders/user/${userId}`);
        if (!response.ok) {
          throw new Error('Failed to fetch orders');
        }
        const result = await response.json();
        console.log('Fetched orders:', result);
        return result.data || [];
      } catch (error) {
        console.error('Error fetching orders:', error);
        throw error;
      }
    }

    // Render orders
    function renderOrders(orders) {
      console.log('Rendering orders:', orders);
      const ordersContainer = document.getElementById('orders-list');
      if (!ordersContainer) {
        console.error('Orders container not found!');
        return;
      }

      if (orders.length === 0) {
        ordersContainer.innerHTML = `
          <div class="empty-orders">
            <i class="fas fa-shopping-bag"></i>
            <h3>No orders yet</h3>
            <p>You haven't placed any orders yet. Start exploring our menu!</p>
            <a href="menu.html" class="action-button">
              <i class="fas fa-utensils"></i>
              Browse Menu
            </a>
          </div>
        `;
        return;
      }

      ordersContainer.innerHTML = orders.map(order => {
        const totalAmount = order.items.reduce((sum, item) => sum + (Number(item.price) * item.quantity), 0);
        console.log('Processing order:', order.id, 'with items:', order.items);
        
        return `
          <div class="order-card">
            <div class="order-header">
              <div class="order-info">
                <div class="order-id">Order #${order.id}</div>
                <div class="order-date">${formatDate(order.created_at)}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="order-status ${getStatusClass(order.status)}">
                  ${order.status}
                </div>
                <div class="order-actions">
                  ${order.status === 'PENDING' ? `
                    <button class="action-btn edit-btn" onclick="editOrder(${order.id})">
                      <i class="fas fa-edit"></i>
                      Edit
                    </button>
                    <button class="action-btn cancel-btn" onclick="cancelOrder(${order.id})">
                      <i class="fas fa-times"></i>
                      Cancel
                    </button>
                  ` : ''}
                  <button class="action-btn delete-btn" onclick="deleteOrder(${order.id})">
                    <i class="fas fa-trash"></i>
                    Delete
                  </button>
                </div>
              </div>
            </div>

            <div class="restaurant-info">
              <i class="fas fa-store restaurant-icon"></i>
              <span>${order.restaurant_name}</span>
            </div>

            <div class="order-items">
              ${order.items.map(item => `
                <div class="order-item">
                  <img src="${item.image_url}" alt="${item.title}" class="item-image">
                  <div class="item-details">
                    <h4 class="item-name">${item.title}</h4>
                    <p class="item-price">RM ${Number(item.price).toFixed(2)}</p>
                  </div>
                  <div class="item-quantity">
                    Qty: ${item.quantity}
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="order-total">
              <span>Total Amount:</span>
              <span class="total-amount">RM ${totalAmount.toFixed(2)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // --- Modern Checkout UI ---
    function renderCheckout() {
      const checkoutSection = document.getElementById('checkout-section');
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      let selectedPaymentMethod = window.selectedPaymentMethod || null;
      let appliedVoucher = window.appliedVoucher || null;
      let voucherError = window.voucherError || '';
      let voucherInputValue = window.voucherInputValue || '';
      let orderFeedback = window.orderFeedback || '';
      let isLoading = window.isLoading || false;
      let showModal = window.showModal || false;
      let orderType = window.orderType || 'delivery'; // 'delivery' or 'pickup'

      // Auto-apply voucher from localStorage (set on index page)
      const savedVoucher = localStorage.getItem('selectedVoucher');
      if (savedVoucher && !voucherInputValue) {
        voucherInputValue = savedVoucher;
        localStorage.removeItem('selectedVoucher');
      }

      function getTotals(cart, voucher, orderType) {
        const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) * item.quantity), 0);
        const deliveryFee = orderType === 'delivery' ? 5 : 0;
        let discount = 0;
        if (voucher) {
          if (voucher.type === 'percentage') discount = subtotal * voucher.discount;
          else if (voucher.type === 'fixed') discount = voucher.discount;
        }
        const total = Math.max(0, subtotal + deliveryFee - discount);
        return { subtotal, deliveryFee, discount, total };
      }

      function orderTypeHTML(selected) {
        return `
          <div class="order-type-toggle" style="display:flex; gap:1.5rem; align-items:center; margin-bottom:1.5rem;">
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
              <input type="radio" name="orderType" value="delivery" ${selected==='delivery'?'checked':''} style="accent-color:#ff5722;"> <i class="fas fa-truck"></i> Delivery
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
              <input type="radio" name="orderType" value="pickup" ${selected==='pickup'?'checked':''} style="accent-color:#ff5722;"> <i class="fas fa-store"></i> Self Pick Up
            </label>
          </div>
        `;
      }

      function paymentMethodsHTML(selected) {
        return `
          <div class="payment-methods">
            <div class="payment-method${selected==='card'?' selected':''}" data-method="card" tabindex="0">
              <div class="payment-icon"><i class="fas fa-credit-card"></i></div>
              <div class="payment-info"><h3>Credit/Debit Card</h3><p>Visa, Mastercard, Amex</p></div>
            </div>
            <div class="payment-method${selected==='bank'?' selected':''}" data-method="bank" tabindex="0">
              <div class="payment-icon"><i class="fas fa-university"></i></div>
              <div class="payment-info"><h3>Online Banking</h3><p>FPX, Maybank2u, CIMB Clicks</p></div>
            </div>
            <div class="payment-method${selected==='ewallet'?' selected':''}" data-method="ewallet" tabindex="0">
              <div class="payment-icon"><i class="fas fa-wallet"></i></div>
              <div class="payment-info"><h3>eWallet</h3><p>Touch 'n Go, GrabPay</p></div>
            </div>
          </div>
        `;
      }

      function paymentDetailsHTML(method) {
        if (method === 'card') {
          return `
            <div class="form-group"><label>Card Number</label><input type="text" placeholder="1234 5678 9012 3456" maxlength="19"></div>
            <div class="form-group"><label>Cardholder Name</label><input type="text" placeholder="John Doe"></div>
            <div class="card-row" style="display:flex; gap:1rem;">
              <div class="form-group"><label>Expiry Date</label><input type="text" placeholder="MM/YY" maxlength="5"></div>
              <div class="form-group"><label>CVV</label><input type="text" placeholder="123" maxlength="3"></div>
            </div>
          `;
        } else if (method === 'bank') {
          return `
            <div class="form-group"><label>Select Bank</label>
              <select id="bank-select"><option value="">Select your bank</option><option>Maybank</option><option>CIMB</option><option>Public Bank</option><option>RHB</option></select>
            </div>
          `;
        } else if (method === 'ewallet') {
          return `
            <div class="form-group"><label>eWallet Account</label><input type="text" placeholder="Enter your eWallet account"></div>
          `;
        }
        return '';
      }

      function cartItemsHTML(cart) {
        return cart.map(item => `
          <div class="order-item">
            <img src="${item.image}" alt="${item.name}" class="item-image">
            <div class="item-details">
              <h4 class="item-name">${item.name}</h4>
              <p class="item-price">RM ${Number(item.price).toFixed(2)}</p>
            </div>
            <div class="item-controls">
              <button class="quantity-control" onclick="updateCartQuantity(${item.id}, -1)">-</button>
              <span class="item-quantity-display">${item.quantity}</span>
              <button class="quantity-control" onclick="updateCartQuantity(${item.id}, 1)">+</button>
              <button class="delete-cart-item-btn" onclick="removeCartItem(${item.id})">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        `).join('');
      }


      function render() {
        cart = JSON.parse(localStorage.getItem('cart')) || [];
        let voucherCode = appliedVoucher ? appliedVoucher.code : voucherInputValue;
        const { subtotal, deliveryFee, discount, total } = getTotals(cart, appliedVoucher, orderType);
        checkoutSection.innerHTML = '';
        if (cart.length === 0) {
          checkoutSection.innerHTML = `<div class='empty-cart' style='text-align:center;padding:3rem;background:#2a2a2a;border-radius:12px;color:#888;'><i class='fas fa-shopping-cart' style='font-size:3rem;margin-bottom:1rem;color:#666;'></i><h3>Your cart is empty</h3><p>Looks like you haven't added any items to your cart yet.</p><a href='menu.html' class='action-button' style='display:inline-flex;align-items:center;gap:0.5rem;background:#ff5722;color:white;border:none;padding:0.8rem 1.5rem;border-radius:8px;font-weight:600;text-decoration:none;transition:background-color 0.3s ease;'><i class='fas fa-utensils'></i>Browse Menu</a></div>`;
          return;
        }
        checkoutSection.innerHTML = `
          <div class="checkout-grid">
            <div class="cart-section">
              <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Your Cart</h2>
              <div class="cart-items">${cartItemsHTML(cart)}</div>
            </div>
            <div class="summary-section" style="position:sticky; top:2rem;">
              <h2 class="summary-title"><i class="fas fa-receipt"></i> Order Summary</h2>
              ${orderTypeHTML(orderType)}
              <div class="summary-row"><span>Subtotal</span><span>RM ${subtotal.toFixed(2)}</span></div>
              ${discount > 0 ? `<div class="summary-row discount-row"><span>Discount</span><span class="amount">-RM ${discount.toFixed(2)}</span></div>` : ''}
              ${orderType === 'delivery' ? `<div class="summary-row"><span>Delivery Fee</span><span>RM ${deliveryFee.toFixed(2)}</span></div>` : ''}
              <div class="summary-row total"><span>Total</span><span class="amount">RM ${total.toFixed(2)}</span></div>
              <div class="voucher-section" id="voucher-section" style="margin:1.5rem 0; padding:1.5rem; background:#2a2a2a; border-radius:12px;">
                <h3 class="section-title">Apply Voucher <i class="fas fa-tag" title="Enter a valid voucher code"></i></h3>
                <div class="voucher-input-group" style="display:flex; gap:1rem; margin-bottom:1rem;">
                  <input type="text" class="voucher-input" placeholder="Enter voucher code" id="voucher-input" value="${voucherCode || ''}" aria-label="Voucher code">
                  <button class="apply-voucher-btn" id="apply-voucher-btn">Apply</button>
                </div>
                <div id="voucher-message" class="voucher-message" style="color:${voucherError ? '#f44336' : '#4caf50'};">${voucherError || (appliedVoucher ? 'Voucher applied! ' + appliedVoucher.description : '')}</div>
              </div>
              <div class="payment-section">
                <h2 class="section-title"><i class="fas fa-credit-card"></i> Payment Method</h2>
                ${paymentMethodsHTML(selectedPaymentMethod)}
                <div id="payment-details" class="payment-details" style="margin-top:1.5rem;">${paymentDetailsHTML(selectedPaymentMethod)}</div>
                <button id="checkout-btn" class="checkout-btn" style="width:100%; background:#ff5722; color:white; border:none; padding:1rem; border-radius:8px; font-weight:600; font-size:1.1rem; cursor:pointer; transition:background-color 0.3s ease; margin-top:1.5rem;${!selectedPaymentMethod ? 'opacity:0.5;pointer-events:none;' : ''}" ${!selectedPaymentMethod ? 'disabled' : ''}>${isLoading ? '<span class="spinner"></span>' : 'Place Order'}</button>
                <div id="order-feedback" style="margin-top:1rem; color:${orderFeedback.startsWith('Success') ? '#4caf50' : '#f44336'}; font-weight:600;">${orderFeedback}</div>
              </div>
            </div>
          </div>
          ${showModal ? `
            <div class="modal-overlay" tabindex="-1">
              <div class="modal">
                <h2><i class="fas fa-check-circle"></i> Order Placed!</h2>
                <p>Your order has been placed successfully.<br>Thank you for ordering with FoodStudent!</p>
                <button class="modal-btn" id="close-modal-btn">OK</button>
              </div>
            </div>
          ` : ''}
        `;

        // Order type selection
        document.querySelectorAll('input[name="orderType"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            window.orderType = e.target.value;
            renderCheckout();
          });
        });

        // Payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
          method.addEventListener('click', () => {
            window.selectedPaymentMethod = method.dataset.method;
            // Reset selectedBank if not bank
            if (window.selectedPaymentMethod !== 'bank') window.selectedBank = '';
            renderCheckout();
          });
        });

        // Bank selection event
        if (selectedPaymentMethod === 'bank') {
          const bankSelect = document.getElementById('bank-select');
          if (bankSelect) {
            bankSelect.value = window.selectedBank || '';
            bankSelect.addEventListener('change', (e) => {
              window.selectedBank = e.target.value;
              renderCheckout();
            });
          }
        }

        // Voucher apply
        document.getElementById('apply-voucher-btn').onclick = async () => {
          const code = document.getElementById('voucher-input').value.trim().toUpperCase();
          window.voucherInputValue = code;
          // Get subtotal and orderType
          const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) * item.quantity), 0);
          try {
            const response = await fetch('/api/vouchers/validate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code, subtotal, orderType })
            });
            const result = await response.json();
            if (result.success) {
              window.appliedVoucher = result.voucher;
              window.voucherError = '';
              showToast('Voucher applied!');
            } else {
              window.appliedVoucher = null;
              window.voucherError = result.message || 'Invalid voucher';
              showToast(window.voucherError, '#f44336');
            }
          } catch (err) {
            window.appliedVoucher = null;
            window.voucherError = 'Error validating voucher';
          }
          renderCheckout();
        };

        // Place order
        document.getElementById('checkout-btn').onclick = async () => {
          if (!selectedPaymentMethod) {
            window.orderFeedback = 'Please select a payment method.';
            renderCheckout();
            return;
          }
          if (cart.length === 0) {
            window.orderFeedback = 'Your cart is empty.';
            renderCheckout();
            return;
          }
          // Validate bank selection if payment method is bank
          if (selectedPaymentMethod === 'bank' && (!window.selectedBank || window.selectedBank === '')) {
            window.orderFeedback = 'Please select your bank.';
            renderCheckout();
            return;
          }

          window.isLoading = true;
          renderCheckout();

          try {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
              throw new Error('Please login to place an order');
            }

            // Create order for each item in cart
            for (const item of cart) {
              const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  user_id: user.id,
                  menu_item_id: item.id,
                  quantity: item.quantity
                })
              });

              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to place order');
              }
            }

            // Clear cart and show success
            window.orderFeedback = '';
            localStorage.setItem('cart', JSON.stringify([]));
            window.appliedVoucher = null;
            window.voucherError = '';
            window.voucherInputValue = '';
            window.selectedPaymentMethod = null;
            window.selectedBank = '';
            window.isLoading = false;
            window.showModal = true;

            showToast('Order placed successfully!');

            // Fetch and display updated orders
            try {
              const orders = await fetchUserOrders(user.id);
              renderOrders(orders);
            } catch (error) {
              console.error('Error fetching updated orders:', error);
            }

            renderCheckout();
          } catch (error) {
            window.isLoading = false;
            window.orderFeedback = error.message;
            renderCheckout();
          }
        };

        // Disable Place Order button if required fields are missing
        const checkoutBtn = document.getElementById('checkout-btn');
        let disableBtn = false;
        if (!selectedPaymentMethod) disableBtn = true;
        if (selectedPaymentMethod === 'bank' && (!window.selectedBank || window.selectedBank === '')) disableBtn = true;
        if (cart.length === 0) disableBtn = true;
        if (disableBtn) {
          checkoutBtn.disabled = true;
          checkoutBtn.style.opacity = 0.5;
          checkoutBtn.style.pointerEvents = 'none';
        } else {
          checkoutBtn.disabled = false;
          checkoutBtn.style.opacity = 1;
          checkoutBtn.style.pointerEvents = 'auto';
        }

        // Modal close
        if (showModal) {
          document.getElementById('close-modal-btn').onclick = () => {
            window.showModal = false;
            window.orderFeedback = 'Order Complete! Thank you for your order.';
            renderCheckout();
          };
        }
      }

      render();
    }

    function updateCartQuantity(itemId, change) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      const itemIndex = cart.findIndex(item => item.id === itemId);
      if (itemIndex > -1) {
        cart[itemIndex].quantity += change;
        if (cart[itemIndex].quantity <= 0) {
          cart.splice(itemIndex, 1);
          showToast('Item removed from cart', '#f44336');
        } else {
          showToast('Cart updated');
        }
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCheckout();
    }

    function removeCartItem(itemId) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart = cart.filter(item => item.id !== itemId);
      localStorage.setItem('cart', JSON.stringify(cart));
      showToast('Item removed from cart', '#f44336');
      renderCheckout();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Page loaded, initializing...');
      renderCheckout();
      
      // Initialize orders display
      const user = getCurrentUser();
      console.log('Current user:', user);
      
      if (user) {
        try {
          const orders = await fetchUserOrders(user.id);
          renderOrders(orders);
        } catch (error) {
          console.error('Error fetching orders:', error);
          const ordersContainer = document.getElementById('orders-list');
          if (ordersContainer) {
            ordersContainer.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                Failed to load orders. Please try again later.
              </div>
            `;
          }
        }
      } else {
        console.log('No user logged in');
        const ordersContainer = document.getElementById('orders-list');
        if (ordersContainer) {
          ordersContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              Please log in to view your orders.
            </div>
          `;
        }
      }
    });

    // Global variables for edit/delete functionality
    let currentOrderId = null;
    let currentOrderData = null;

    // Edit order function
    async function editOrder(orderId) {
      try {
        // Fetch order details
        const response = await fetch(`/api/orders/${orderId}`);
        if (!response.ok) {
          throw new Error('Failed to fetch order details');
        }
        const result = await response.json();
        currentOrderData = result.data;
        currentOrderId = orderId;

        // Populate form
        document.getElementById('edit-status').value = currentOrderData.status.toLowerCase();
        if (currentOrderData.items && currentOrderData.items.length > 0) {
          document.getElementById('edit-quantity').value = currentOrderData.items[0].quantity;
        }

        // Show modal
        document.getElementById('edit-modal').classList.add('show');
      } catch (error) {
        console.error('Error fetching order details:', error);
        alert('Failed to load order details. Please try again.');
      }
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('show');
      currentOrderId = null;
      currentOrderData = null;
    }

    // Save order changes
    async function saveOrderChanges(formData) {
      try {
        const saveBtn = document.getElementById('save-order-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        // Update order status
        const statusResponse = await fetch(`/api/orders/${currentOrderId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: formData.get('status')
          })
        });

        if (!statusResponse.ok) {
          throw new Error('Failed to update order status');
        }

        // Update order item quantity if changed
        const newQuantity = parseInt(formData.get('quantity'));
        if (currentOrderData.items && currentOrderData.items.length > 0) {
          const currentQuantity = currentOrderData.items[0].quantity;
          if (newQuantity !== currentQuantity) {
            const itemId = currentOrderData.items[0].id;
            const quantityResponse = await fetch(`/api/orders/${currentOrderId}/items/${itemId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                quantity: newQuantity
              })
            });

            if (!quantityResponse.ok) {
              throw new Error('Failed to update order quantity');
            }
          }
        }

        closeEditModal();
        
        // Refresh orders list
        const user = getCurrentUser();
        if (user) {
          const orders = await fetchUserOrders(user.id);
          renderOrders(orders);
        }

        showToast('Order updated successfully!');
      } catch (error) {
        console.error('Error updating order:', error);
        showToast('Failed to update order', '#f44336');
      } finally {
        const saveBtn = document.getElementById('save-order-btn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    // Cancel order function
    async function cancelOrder(orderId) {
      if (confirm('Are you sure you want to cancel this order?')) {
        try {
          const response = await fetch(`/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              status: 'cancelled'
            })
          });

          if (!response.ok) {
            throw new Error('Failed to cancel order');
          }

          // Refresh orders list
          const user = getCurrentUser();
          if (user) {
            const orders = await fetchUserOrders(user.id);
            renderOrders(orders);
          }

          showToast('Order cancelled successfully!');
        } catch (error) {
          console.error('Error cancelling order:', error);
          showToast('Failed to cancel order', '#f44336');
        }
      }
    }

    // Delete order function
    function deleteOrder(orderId) {
      currentOrderId = orderId;
      document.getElementById('confirm-modal').classList.add('show');
    }

    // Close confirmation modal
    function closeConfirmModal() {
      document.getElementById('confirm-modal').classList.remove('show');
      currentOrderId = null;
    }

    // Confirm delete order
    async function confirmDeleteOrder() {
      try {
        const confirmBtn = document.getElementById('confirm-delete-btn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Deleting...';

        const response = await fetch(`/api/orders/${currentOrderId}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error('Failed to delete order');
        }

        closeConfirmModal();
        
        // Refresh orders list
        const user = getCurrentUser();
        if (user) {
          const orders = await fetchUserOrders(user.id);
          renderOrders(orders);
        }

        showToast('Order deleted successfully!');
      } catch (error) {
        console.error('Error deleting order:', error);
        showToast('Failed to delete order', '#f44336');
      } finally {
        const confirmBtn = document.getElementById('confirm-delete-btn');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Delete Order';
      }
    }

    // Event listeners for modals
    document.addEventListener('DOMContentLoaded', () => {
      // Edit form submission
      document.getElementById('edit-order-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        saveOrderChanges(formData);
      });

      // Confirm delete button
      document.getElementById('confirm-delete-btn').addEventListener('click', confirmDeleteOrder);

      // Close modals when clicking outside
      document.getElementById('edit-modal').addEventListener('click', (e) => {
        if (e.target.id === 'edit-modal') {
          closeEditModal();
        }
      });

      document.getElementById('confirm-modal').addEventListener('click', (e) => {
        if (e.target.id === 'confirm-modal') {
          closeConfirmModal();
        }
      });
    });

    // Add toast notification system
    function showToast(message, color = '#4caf50') {
      let toast = document.getElementById('toast-notification');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.style.position = 'fixed';
        toast.style.bottom = '32px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = color;
        toast.style.color = '#fff';
        toast.style.padding = '1rem 2rem';
        toast.style.borderRadius = '8px';
        toast.style.fontWeight = '600';
        toast.style.fontSize = '1.1rem';
        toast.style.zIndex = '9999';
        toast.style.boxShadow = '0 4px 16px rgba(0,0,0,0.18)';
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.background = color;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }
  </script>
</body>
</html>
